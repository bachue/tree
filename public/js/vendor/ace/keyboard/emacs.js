define(function(require,exports,module){"use strict";var dom=require("../lib/dom");require("../incremental_search");var iSearchCommandModule=require("../commands/incremental_search_commands");var screenToTextBlockCoordinates=function(x,y){var canvasPos=this.scroller.getBoundingClientRect();var col=Math.floor((x+this.scrollLeft-canvasPos.left-this.$padding)/this.characterWidth);var row=Math.floor((y+this.scrollTop-canvasPos.top)/this.lineHeight);return this.session.screenToDocumentPosition(row,col)};var HashHandler=require("./hash_handler").HashHandler;exports.handler=new HashHandler;exports.handler.isEmacs=true;exports.handler.$id="ace/keyboard/emacs";var initialized=false;var $formerLongWords;var $formerLineStart;exports.handler.attach=function(editor){if(!initialized){initialized=true;dom.importCssString("            .emacs-mode .ace_cursor{                border: 2px rgba(50,250,50,0.8) solid!important;                -moz-box-sizing: border-box!important;                -webkit-box-sizing: border-box!important;                box-sizing: border-box!important;                background-color: rgba(0,250,0,0.9);                opacity: 0.5;            }            .emacs-mode .ace_hidden-cursors .ace_cursor{                opacity: 1;                background-color: transparent;            }            .emacs-mode .ace_overwrite-cursors .ace_cursor {                opacity: 1;                background-color: transparent;                border-width: 0 0 2px 2px !important;            }            .emacs-mode .ace_text-layer {                z-index: 4            }            .emacs-mode .ace_cursor-layer {                z-index: 2            }","emacsMode")}$formerLongWords=editor.session.$selectLongWords;editor.session.$selectLongWords=true;$formerLineStart=editor.session.$useEmacsStyleLineStart;editor.session.$useEmacsStyleLineStart=true;editor.session.$emacsMark=null;editor.session.$emacsMarkRing=editor.session.$emacsMarkRing||[];editor.emacsMark=function(){return this.session.$emacsMark};editor.setEmacsMark=function(p){this.session.$emacsMark=p};editor.pushEmacsMark=function(p,activate){var prevMark=this.session.$emacsMark;if(prevMark)this.session.$emacsMarkRing.push(prevMark);if(!p||activate)this.setEmacsMark(p);else this.session.$emacsMarkRing.push(p)};editor.popEmacsMark=function(){var mark=this.emacsMark();if(mark){this.setEmacsMark(null);return mark}return this.session.$emacsMarkRing.pop()};editor.getLastEmacsMark=function(p){return this.session.$emacsMark||this.session.$emacsMarkRing.slice(-1)[0]};editor.on("click",$resetMarkMode);editor.on("changeSession",$kbSessionChange);editor.renderer.screenToTextCoordinates=screenToTextBlockCoordinates;editor.setStyle("emacs-mode");editor.commands.addCommands(commands);exports.handler.platform=editor.commands.platform;editor.$emacsModeHandler=this;editor.addEventListener("copy",this.onCopy);editor.addEventListener("paste",this.onPaste)};exports.handler.detach=function(editor){delete editor.renderer.screenToTextCoordinates;editor.session.$selectLongWords=$formerLongWords;editor.session.$useEmacsStyleLineStart=$formerLineStart;editor.removeEventListener("click",$resetMarkMode);editor.removeEventListener("changeSession",$kbSessionChange);editor.unsetStyle("emacs-mode");editor.commands.removeCommands(commands);editor.removeEventListener("copy",this.onCopy);editor.removeEventListener("paste",this.onPaste)};var $kbSessionChange=function(e){if(e.oldSession){e.oldSession.$selectLongWords=$formerLongWords;e.oldSession.$useEmacsStyleLineStart=$formerLineStart}$formerLongWords=e.session.$selectLongWords;e.session.$selectLongWords=true;$formerLineStart=e.session.$useEmacsStyleLineStart;e.session.$useEmacsStyleLineStart=true;if(!e.session.hasOwnProperty("$emacsMark"))e.session.$emacsMark=null;if(!e.session.hasOwnProperty("$emacsMarkRing"))e.session.$emacsMarkRing=[]};var $resetMarkMode=function(e){e.editor.session.$emacsMark=null};var keys=require("../lib/keys").KEY_MODS;var eMods={C:"ctrl",S:"shift",M:"alt",CMD:"command"};var combinations=["C-S-M-CMD","S-M-CMD","C-M-CMD","C-S-CMD","C-S-M","M-CMD","S-CMD","S-M","C-CMD","C-M","C-S","CMD","M","S","C"];combinations.forEach(function(c){var hashId=0;c.split("-").forEach(function(c){hashId=hashId|keys[eMods[c]]});eMods[hashId]=c.toLowerCase()+"-"});exports.handler.onCopy=function(e,editor){if(editor.$handlesEmacsOnCopy)return;editor.$handlesEmacsOnCopy=true;exports.handler.commands.killRingSave.exec(editor);delete editor.$handlesEmacsOnCopy};exports.handler.onPaste=function(e,editor){editor.pushEmacsMark(editor.getCursorPosition())};exports.handler.bindKey=function(key,command){if(!key)return;var ckb=this.commandKeyBinding;key.split("|").forEach(function(keyPart){keyPart=keyPart.toLowerCase();ckb[keyPart]=command;var keyParts=keyPart.split(" ").slice(0,-1);keyParts.reduce(function(keyMapKeys,keyPart,i){var prefix=keyMapKeys[i-1]?keyMapKeys[i-1]+" ":"";return keyMapKeys.concat([prefix+keyPart])},[]).forEach(function(keyPart){if(!ckb[keyPart])ckb[keyPart]="null"})},this)};exports.handler.handleKeyboard=function(data,hashId,key,keyCode){if(keyCode===-1)return undefined;var editor=data.editor;if(hashId==-1){editor.pushEmacsMark();if(data.count){var str=new Array(data.count+1).join(key);data.count=null;return{command:"insertstring",args:str}}}if(key=="\x00")return undefined;var modifier=eMods[hashId];if(modifier=="c-"||data.universalArgument){var prevCount=String(data.count||0);var count=parseInt(key[key.length-1]);if(typeof count==="number"&&!isNaN(count)){data.count=parseInt(prevCount+count);return{command:"null"}}else if(data.universalArgument){data.count=4}}data.universalArgument=false;if(modifier)key=modifier+key;if(data.keyChain)key=data.keyChain+=" "+key;var command=this.commandKeyBinding[key];data.keyChain=command=="null"?key:"";if(!command)return undefined;if(command==="null")return{command:"null"};if(command==="universalArgument"){data.universalArgument=true;return{command:"null"}}var args;if(typeof command!=="string"){args=command.args;if(command.command)command=command.command;if(command==="goorselect"){command=editor.emacsMark()?args[1]:args[0];args=null}}if(typeof command==="string"){if(command==="insertstring"||command==="splitline"||command==="togglecomment"){editor.pushEmacsMark()}command=this.commands[command]||editor.commands.commands[command];if(!command)return undefined}if(!command.readonly&&!command.isYank)data.lastCommand=null;if(data.count){var count=data.count;data.count=0;if(!command||!command.handlesCount){return{args:args,command:{exec:function(editor,args){for(var i=0;i<count;i++)command.exec(editor,args)}}}}else{if(!args)args={};if(typeof args==="object")args.count=count}}return{command:command,args:args}};exports.emacsKeys={"Up|C-p":{command:"goorselect",args:["golineup","selectup"]},"Down|C-n":{command:"goorselect",args:["golinedown","selectdown"]},"Left|C-b":{command:"goorselect",args:["gotoleft","selectleft"]},"Right|C-f":{command:"goorselect",args:["gotoright","selectright"]},"C-Left|M-b":{command:"goorselect",args:["gotowordleft","selectwordleft"]},"C-Right|M-f":{command:"goorselect",args:["gotowordright","selectwordright"]},"Home|C-a":{command:"goorselect",args:["gotolinestart","selecttolinestart"]},"End|C-e":{command:"goorselect",args:["gotolineend","selecttolineend"]},"C-Home|S-M-,":{command:"goorselect",args:["gotostart","selecttostart"]},"C-End|S-M-.":{command:"goorselect",args:["gotoend","selecttoend"]},"S-Up|S-C-p":"selectup","S-Down|S-C-n":"selectdown","S-Left|S-C-b":"selectleft","S-Right|S-C-f":"selectright","S-C-Left|S-M-b":"selectwordleft","S-C-Right|S-M-f":"selectwordright","S-Home|S-C-a":"selecttolinestart","S-End|S-C-e":"selecttolineend","S-C-Home":"selecttostart","S-C-End":"selecttoend","C-l":"recenterTopBottom","M-s":"centerselection","M-g":"gotoline","C-x C-p":"selectall","C-Down":{command:"goorselect",args:["gotopagedown","selectpagedown"]},"C-Up":{command:"goorselect",args:["gotopageup","selectpageup"]},"PageDown|C-v":{command:"goorselect",args:["gotopagedown","selectpagedown"]},"PageUp|M-v":{command:"goorselect",args:["gotopageup","selectpageup"]},"S-C-Down":"selectpagedown","S-C-Up":"selectpageup","C-s":"iSearch","C-r":"iSearchBackwards","M-C-s":"findnext","M-C-r":"findprevious","S-M-5":"replace",Backspace:"backspace","Delete|C-d":"del","Return|C-m":{command:"insertstring",args:"\n"},"C-o":"splitline","M-d|C-Delete":{command:"killWord",args:"right"},"C-Backspace|M-Backspace|M-Delete":{command:"killWord",args:"left"},"C-k":"killLine","C-y|S-Delete":"yank","M-y":"yankRotate","C-g":"keyboardQuit","C-w":"killRegion","M-w":"killRingSave","C-Space":"setMark","C-x C-x":"exchangePointAndMark","C-t":"transposeletters","M-u":"touppercase","M-l":"tolowercase","M-/":"autocomplete","C-u":"universalArgument","M-;":"togglecomment","C-/|C-x u|S-C--|C-z":"undo","S-C-/|S-C-x u|C--|S-C-z":"redo","C-x r":"selectRectangularRegion","M-x":{command:"focusCommandLine",args:"M-x "}};exports.handler.bindKeys(exports.emacsKeys);exports.handler.addCommands({recenterTopBottom:function(editor){var renderer=editor.renderer;var pos=renderer.$cursorLayer.getPixelPosition();var h=renderer.$size.scrollerHeight-renderer.lineHeight;var scrollTop=renderer.scrollTop;if(Math.abs(pos.top-scrollTop)<2){scrollTop=pos.top-h}else if(Math.abs(pos.top-scrollTop-h*.5)<2){scrollTop=pos.top}else{scrollTop=pos.top-h*.5}editor.session.setScrollTop(scrollTop)},selectRectangularRegion:function(editor){editor.multiSelect.toggleBlockSelection()},setMark:{exec:function(editor,args){if(args&&args.count){var mark=editor.popEmacsMark();mark&&editor.selection.moveCursorToPosition(mark);return}var mark=editor.emacsMark(),transientMarkModeActive=true;if(transientMarkModeActive&&(mark||!editor.selection.isEmpty())){editor.pushEmacsMark();editor.clearSelection();return}if(mark){var cp=editor.getCursorPosition();if(editor.selection.isEmpty()&&mark.row==cp.row&&mark.column==cp.column){editor.pushEmacsMark();return}}mark=editor.getCursorPosition();editor.setEmacsMark(mark);editor.selection.setSelectionAnchor(mark.row,mark.column)},readonly:true,handlesCount:true,multiSelectAction:"forEach"},exchangePointAndMark:{exec:function(editor,args){var sel=editor.selection;if(args.count){var pos=editor.getCursorPosition();sel.clearSelection();sel.moveCursorToPosition(editor.popEmacsMark());editor.pushEmacsMark(pos);return}var lastMark=editor.getLastEmacsMark();var range=sel.getRange();if(range.isEmpty()){sel.selectToPosition(lastMark);return}sel.setSelectionRange(range,!sel.isBackwards())},readonly:true,handlesCount:true,multiSelectAction:"forEach"},killWord:{exec:function(editor,dir){editor.clearSelection();if(dir=="left")editor.selection.selectWordLeft();else editor.selection.selectWordRight();var range=editor.getSelectionRange();var text=editor.session.getTextRange(range);exports.killRing.add(text);editor.session.remove(range);editor.clearSelection()},multiSelectAction:"forEach"},killLine:function(editor){editor.pushEmacsMark(null);var pos=editor.getCursorPosition();if(pos.column===0&&editor.session.doc.getLine(pos.row).length===0){editor.selection.selectLine()}else{editor.clearSelection();editor.selection.selectLineEnd()}var range=editor.getSelectionRange();var text=editor.session.getTextRange(range);exports.killRing.add(text);editor.session.remove(range);editor.clearSelection()},yank:function(editor){editor.onPaste(exports.killRing.get()||"");editor.keyBinding.$data.lastCommand="yank"},yankRotate:function(editor){if(editor.keyBinding.$data.lastCommand!="yank")return;editor.undo();editor.onPaste(exports.killRing.rotate());editor.keyBinding.$data.lastCommand="yank"},killRegion:{exec:function(editor){exports.killRing.add(editor.getCopyText());editor.commands.byName.cut.exec(editor)},readonly:true,multiSelectAction:"forEach"},killRingSave:{exec:function(editor){exports.killRing.add(editor.getCopyText());setTimeout(function(){var sel=editor.selection,range=sel.getRange();editor.pushEmacsMark(sel.isBackwards()?range.end:range.start);sel.clearSelection()},0)},readonly:true},keyboardQuit:function(editor){editor.selection.clearSelection();editor.setEmacsMark(null)},focusCommandLine:function(editor,arg){if(editor.showCommandLine)editor.showCommandLine(arg)}});exports.handler.addCommands(iSearchCommandModule.iSearchStartCommands);var commands=exports.handler.commands;commands.yank.isYank=true;commands.yankRotate.isYank=true;exports.killRing={$data:[],add:function(str){str&&this.$data.push(str);if(this.$data.length>30)this.$data.shift()},get:function(n){n=n||1;return this.$data.slice(this.$data.length-n,this.$data.length).reverse().join("\n")},pop:function(){if(this.$data.length>1)this.$data.pop();return this.get()},rotate:function(){this.$data.unshift(this.$data.pop());return this.get()}}});