define(function(require,exports,module){"use strict";var oop=require("./lib/oop");var EventEmitter=require("./lib/event_emitter").EventEmitter;var Anchor=exports.Anchor=function(doc,row,column){this.$onChange=this.onChange.bind(this);this.attach(doc);if(typeof column=="undefined")this.setPosition(row.row,row.column);else this.setPosition(row,column)};(function(){oop.implement(this,EventEmitter);this.getPosition=function(){return this.$clipPositionToDocument(this.row,this.column)};this.getDocument=function(){return this.document};this.$insertRight=false;this.onChange=function(e){var delta=e.data;var range=delta.range;if(range.start.row==range.end.row&&range.start.row!=this.row)return;if(range.start.row>this.row)return;if(range.start.row==this.row&&range.start.column>this.column)return;var row=this.row;var column=this.column;var start=range.start;var end=range.end;if(delta.action==="insertText"){if(start.row===row&&start.column<=column){if(start.column===column&&this.$insertRight){}else if(start.row===end.row){column+=end.column-start.column}else{column-=start.column;row+=end.row-start.row}}else if(start.row!==end.row&&start.row<row){row+=end.row-start.row}}else if(delta.action==="insertLines"){if(start.row<=row){row+=end.row-start.row}}else if(delta.action==="removeText"){if(start.row===row&&start.column<column){if(end.column>=column)column=start.column;else column=Math.max(0,column-(end.column-start.column))}else if(start.row!==end.row&&start.row<row){if(end.row===row)column=Math.max(0,column-end.column)+start.column;row-=end.row-start.row}else if(end.row===row){row-=end.row-start.row;column=Math.max(0,column-end.column)+start.column}}else if(delta.action=="removeLines"){if(start.row<=row){if(end.row<=row)row-=end.row-start.row;else{row=start.row;column=0}}}this.setPosition(row,column,true)};this.setPosition=function(row,column,noClip){var pos;if(noClip){pos={row:row,column:column}}else{pos=this.$clipPositionToDocument(row,column)}if(this.row==pos.row&&this.column==pos.column)return;var old={row:this.row,column:this.column};this.row=pos.row;this.column=pos.column;this._signal("change",{old:old,value:pos})};this.detach=function(){this.document.removeEventListener("change",this.$onChange)};this.attach=function(doc){this.document=doc||this.document;this.document.on("change",this.$onChange)};this.$clipPositionToDocument=function(row,column){var pos={};if(row>=this.document.getLength()){pos.row=Math.max(0,this.document.getLength()-1);pos.column=this.document.getLine(pos.row).length}else if(row<0){pos.row=0;pos.column=0}else{pos.row=row;pos.column=Math.min(this.document.getLine(pos.row).length,Math.max(0,column))}if(column<0)pos.column=0;return pos}}).call(Anchor.prototype)});