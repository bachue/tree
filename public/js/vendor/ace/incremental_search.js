define(function(require,exports,module){"use strict";var oop=require("./lib/oop");var Range=require("./range").Range;var Search=require("./search").Search;var SearchHighlight=require("./search_highlight").SearchHighlight;var iSearchCommandModule=require("./commands/incremental_search_commands");var ISearchKbd=iSearchCommandModule.IncrementalSearchKeyboardHandler;function IncrementalSearch(){this.$options={wrap:false,skipCurrent:false};this.$keyboardHandler=new ISearchKbd(this)}oop.inherits(IncrementalSearch,Search);(function(){this.activate=function(ed,backwards){this.$editor=ed;this.$startPos=this.$currentPos=ed.getCursorPosition();this.$options.needle="";this.$options.backwards=backwards;ed.keyBinding.addKeyboardHandler(this.$keyboardHandler);this.$originalEditorOnPaste=ed.onPaste;ed.onPaste=this.onPaste.bind(this);this.$mousedownHandler=ed.addEventListener("mousedown",this.onMouseDown.bind(this));this.selectionFix(ed);this.statusMessage(true)};this.deactivate=function(reset){this.cancelSearch(reset);var ed=this.$editor;ed.keyBinding.removeKeyboardHandler(this.$keyboardHandler);if(this.$mousedownHandler){ed.removeEventListener("mousedown",this.$mousedownHandler);delete this.$mousedownHandler}ed.onPaste=this.$originalEditorOnPaste;this.message("")};this.selectionFix=function(editor){if(editor.selection.isEmpty()&&!editor.session.$emacsMark){editor.clearSelection()}};this.highlight=function(regexp){var sess=this.$editor.session,hl=sess.$isearchHighlight=sess.$isearchHighlight||sess.addDynamicMarker(new SearchHighlight(null,"ace_isearch-result","text"));hl.setRegexp(regexp);sess._emit("changeBackMarker")};this.cancelSearch=function(reset){var e=this.$editor;this.$prevNeedle=this.$options.needle;this.$options.needle="";if(reset){e.moveCursorToPosition(this.$startPos);this.$currentPos=this.$startPos}else{e.pushEmacsMark&&e.pushEmacsMark(this.$startPos,false)}this.highlight(null);return Range.fromPoints(this.$currentPos,this.$currentPos)};this.highlightAndFindWithNeedle=function(moveToNext,needleUpdateFunc){if(!this.$editor)return null;var options=this.$options;if(needleUpdateFunc){options.needle=needleUpdateFunc.call(this,options.needle||"")||""}if(options.needle.length===0){this.statusMessage(true);return this.cancelSearch(true)}options.start=this.$currentPos;var session=this.$editor.session,found=this.find(session);if(found){if(options.backwards)found=Range.fromPoints(found.end,found.start);this.$editor.moveCursorToPosition(found.end);if(moveToNext)this.$currentPos=found.end;this.highlight(options.re)}this.statusMessage(found);return found};this.addString=function(s){return this.highlightAndFindWithNeedle(false,function(needle){return needle+s})};this.removeChar=function(c){return this.highlightAndFindWithNeedle(false,function(needle){return needle.length>0?needle.substring(0,needle.length-1):needle})};this.next=function(options){options=options||{};this.$options.backwards=!!options.backwards;this.$currentPos=this.$editor.getCursorPosition();return this.highlightAndFindWithNeedle(true,function(needle){return options.useCurrentOrPrevSearch&&needle.length===0?this.$prevNeedle||"":needle})};this.onMouseDown=function(evt){this.deactivate();return true};this.onPaste=function(text){this.addString(text)};this.statusMessage=function(found){var options=this.$options,msg="";msg+=options.backwards?"reverse-":"";msg+="isearch: "+options.needle;msg+=found?"":" (not found)";this.message(msg)};this.message=function(msg){if(this.$editor.showCommandLine){this.$editor.showCommandLine(msg);this.$editor.focus()}else{console.log(msg)}}}).call(IncrementalSearch.prototype);exports.IncrementalSearch=IncrementalSearch;var dom=require("./lib/dom");dom.importCssString&&dom.importCssString(".ace_marker-layer .ace_isearch-result {  position: absolute;  z-index: 6;  -moz-box-sizing: border-box;  -webkit-box-sizing: border-box;  box-sizing: border-box;}div.ace_isearch-result {  border-radius: 4px;  background-color: rgba(255, 200, 0, 0.5);  box-shadow: 0 0 4px rgb(255, 200, 0);}.ace_dark div.ace_isearch-result {  background-color: rgb(100, 110, 160);  box-shadow: 0 0 4px rgb(80, 90, 140);}","incremental-search-highlighting");var commands=require("./commands/command_manager");(function(){this.setupIncrementalSearch=function(editor,val){if(this.usesIncrementalSearch==val)return;this.usesIncrementalSearch=val;var iSearchCommands=iSearchCommandModule.iSearchStartCommands;var method=val?"addCommands":"removeCommands";this[method](iSearchCommands)}}).call(commands.CommandManager.prototype);var Editor=require("./editor").Editor;require("./config").defineOptions(Editor.prototype,"editor",{useIncrementalSearch:{set:function(val){this.keyBinding.$handlers.forEach(function(handler){if(handler.setupIncrementalSearch){handler.setupIncrementalSearch(this,val)}});this._emit("incrementalSearchSettingChanged",{isEnabled:val})}}})});